# NEC TK-85にSD-Cardとのロード、セーブ機能

　シリアル同期通信によりTK-85とSD_ACCESS(ARDUINO+SD-CARD)とのロード、セーブを提供するルーチンです。


## 必要なもの
　2716×1

　ピンヘッダ等

## 接続方法
Arduino　　　　　　　　　　TK-85

　　5V　　　　　　　-----　　5V　A3
   
　　GND　　　　　　-----　　GND　A1
   
　　9(FLG:output)　　　-----　　PB2(CHK:input)　A32

　　8(OUT:output)　　-----　　PB0(IN:input)　A30

　　7(CHK:input)　　　-----　　PC2(FLG:output)　A40

　　6(IN:input)　　　　-----　　PC0(OUT:output)　A38

## ROMの差し替え

　MONITOR-ROMの内容を読み出し、バイナリエディタ等で以下のファイルの内容に差し替えます。

　　file_trans_TK85(0425H-0555H).bin

　　file_trans_TK85(06E7H-076EH).bin

　ロード、セーブジャンプ先を修正します。

　　02D1～02D2　　DC->25

　　02D4～02D5　　25->28

　キースキャンルーチンを修正します。

　　06C0　　EF->E0

　　06C7　　DF->D0

　　06CE　　BF->B0

　すべての修正が終わったら用意したROMに焼き、装着します。

## 操作方法
　異常が無いと思われるのにエラーとなってしまう場合にはSD-CardアダプタのArduinoとTK-85の両方をリセットしてからやり直してみてください。

### Save
　MODEキー、SAVEキーを押してからファイルNo(xxxx)を4桁で入力してWR/ENTキーを押します。

　正常にSaveが完了するとアドレス部にスタートアドレス、データ部にエンドアドレスが表示されます。

　　　8000H～8390Hまでをxxxx.BTKとしてセーブします。セーブ範囲は固定となっていて指定はできません。

　「FFFFFFFF」と表示された場合はSD-Card未挿入です。確認してください。

### Load
　MODEキー、LOADキーを押してからファイルNo(xxxx)を4桁で入力してWR/ENTキーを押します。

　　　xxxx.BTKをBTKヘッダ情報で示されたアドレスにロードします。ただし、8391H～83FFHまでの範囲はライトプロテクトされます。

　正常にLoadが完了するとアドレス部にスタートアドレス、データ部にエンドアドレスが表示されます。スタートアドレスが実行開始アドレスであればそのままRUNキーを押すことでプログラムが実行できます。

　「F0F0F0F0F0」と表示された場合はSD-Card未挿入、「F1F1F1F1F1」と表示された場合はファイルNoのファイルが存在しない場合です。確認してください。

## 扱えるファイル
　拡張子btkとなっているバイナリファイルです。

　ファイル名は0000～FFFFまでの16進数4桁を付けてください。(例:1000.btk)

　この16進数4桁がTK-85からSD-Card内のファイルを識別するファイルNoとなります。

　構造的には、バイナリファイル本体データの先頭に4バイトの開始アドレス、終了アドレスを付加した形になっています。

　パソコンのクロスアセンブラ等でTK-85用の実行binファイルを作成したらバイナリエディタ等で先頭に4バイトの開始アドレス、終了アドレスを付加し、ファイル名を変更したものをSD-Cardのルートディレクトリに保存すればTK-85から呼び出せるようになります。

## 修正

2021.10.30 TK-85のワークエリアがTK-80より拡大していたことに気付いたため、セーブ範囲とロード時の除外範囲を修正
